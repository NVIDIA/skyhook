{{- if .Values.webhook.enable }}
{{- if eq .Release.Namespace "default" }}
{{- fail "Deployment to 'default' namespace is not allowed for security reasons. Please specify a different namespace." }}
{{- end }}
apiVersion: batch/v1
kind: Job
metadata:
  name: "{{ include "chart.fullname" . }}-webhook-cleanup"
  namespace: "{{ .Release.Namespace }}"
  annotations:
    "helm.sh/hook": pre-delete
    "helm.sh/hook-delete-policy": before-hook-creation,hook-succeeded
spec:
  template:
    spec:
      restartPolicy: Never
      serviceAccountName: {{ include "chart.fullname" . }}-controller-manager
      containers:
      - name: cleanup
        image: {{ .Values.webhook.removalImage | default "bitnami/kubectl" }}:{{ .Values.webhook.removalTag | default "latest" }}
        securityContext:
          runAsNonRoot: true
          runAsUser: 10001
          allowPrivilegeEscalation: false
          drop:
            - NET_RAW
            - ALL
        resources:
          limits:
            cpu: {{ .Values.limitRange.default.cpu }}
            memory: {{ .Values.limitRange.default.memory }}
          requests:
            cpu: {{ .Values.limitRange.defaultRequest.cpu }}
            memory: {{ .Values.limitRange.defaultRequest.memory }}
        command:
        - /bin/sh
        - -c
        - |
          NAMESPACE="{{ .Release.Namespace }}"
          WEBHOOK_SECRET_NAME="{{ .Values.webhook.secretName | default "webhook-cert" }}"
          VALIDATING_WEBHOOK_CONFIGURATION_NAME="skyhook-operator-validating-webhook"
          MUTATING_WEBHOOK_CONFIGURATION_NAME="skyhook-operator-mutating-webhook"
          kubectl delete secret -n $NAMESPACE $WEBHOOK_SECRET_NAME || true
          kubectl delete validatingwebhookconfiguration $VALIDATING_WEBHOOK_CONFIGURATION_NAME || true
          kubectl delete mutatingwebhookconfiguration $MUTATING_WEBHOOK_CONFIGURATION_NAME || true
{{- end }} 