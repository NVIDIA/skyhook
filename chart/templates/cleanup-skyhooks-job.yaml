{{- if .Values.cleanup.enabled }}
apiVersion: batch/v1
kind: Job
metadata:
  name: "{{ include "chart.fullname" . }}-skyhook-cleanup"
  namespace: "{{ .Release.Namespace }}"
  annotations:
    "helm.sh/hook": pre-delete
    "helm.sh/hook-delete-policy": before-hook-creation,hook-succeeded
    "helm.sh/hook-weight": "-5"
spec:
  activeDeadlineSeconds: {{ .Values.cleanup.jobTimeoutSeconds }}
  template:
    spec:
      restartPolicy: Never
      automountServiceAccountToken: false
      serviceAccountName: {{ include "chart.fullname" . }}-controller-manager
      {{- with .Values.controllerManager.tolerations }}
      tolerations:
        {{- toYaml . | nindent 6 }}
      {{- end }}
      securityContext:
        runAsNonRoot: true
        runAsUser: 10001
        seccompProfile:
          type: RuntimeDefault
      volumes:
      - name: kube-api-access
        projected:
          defaultMode: 420
          sources:
          - serviceAccountToken:
              path: token
              expirationSeconds: 3607
          - configMap:
              items:
              - key: ca.crt
                path: ca.crt
              name: kube-root-ca.crt
          - downwardAPI:
              items:
              - fieldRef:
                  apiVersion: v1
                  fieldPath: metadata.namespace
                path: namespace
      containers:
      - name: cleanup
        image: {{ .Values.webhook.removalImage | default "bitnami/kubectl" }}{{- if .Values.webhook.removalDigest }}{{- if .Values.webhook.removalTag }}:{{ .Values.webhook.removalTag | default "latest" }}@{{ .Values.webhook.removalDigest }}{{- else }}@{{ .Values.webhook.removalDigest }}{{- end }}{{- else }}:{{ .Values.webhook.removalTag | default "latest" }}{{- end }}
        imagePullPolicy: Always
        securityContext:
          allowPrivilegeEscalation: false
          readOnlyRootFilesystem: true
          capabilities:
            drop:
            - ALL
          seccompProfile:
            type: RuntimeDefault
        volumeMounts:
        - mountPath: /var/run/secrets/kubernetes.io/serviceaccount
          name: kube-api-access
          readOnly: true
        resources:
          limits:
            cpu: {{ .Values.limitRange.default.cpu }}
            memory: {{ .Values.limitRange.default.memory }}
          requests:
            cpu: {{ .Values.limitRange.defaultRequest.cpu }}
            memory: {{ .Values.limitRange.defaultRequest.memory }}
        command:
        - /bin/sh
        - -c
        - |
          # Delete all Skyhook resources (cluster-scoped)
          # Using || true to ensure job succeeds even if delete times out
          kubectl delete skyhooks --all --ignore-not-found || true
          # Delete all DeploymentPolicy resources (cluster-scoped)
          kubectl delete deploymentpolicies --all --ignore-not-found || true
          echo "Cleanup completed"
{{- end }}
