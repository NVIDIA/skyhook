# SPDX-FileCopyrightText: Copyright (c) 2025 NVIDIA CORPORATION & AFFILIATES. All rights reserved.
# SPDX-License-Identifier: Apache-2.0
#
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
# http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

# SPDX-FileCopyrightText: Copyright (c) 2025 NVIDIA CORPORATION & AFFILIATES. All rights reserved.
# SPDX-License-Identifier: Apache-2.0

apiVersion: skyhook.nvidia.com/v1alpha1
kind: Skyhook
metadata:
  name: overlapping-selectors-test
status:
  compartmentStatuses:
    us-west:
      matched: 2
      ceiling: 2
    production:
      matched: 2
      ceiling: 2
    prod-us-west:
      matched: 2
      ceiling: 1
  nodeStatus:
    # REGRESSION TEST: Nodes assigned to compartments but not yet selected for batches should be "waiting", not "unknown"
    # This verifies that nodes waiting for batch selection have the correct status
    #
    # With 6 nodes total (2 per compartment) and initialBatch=1 per compartment:
    # - 3 nodes should be "in_progress" (1 per compartment, selected for batch 1)
    # - 3 nodes should be "waiting" (1 per compartment, not yet selected)
    #
    # Count occurrences using JMESPath array filtering: verify exactly 3 "waiting" and 3 "in_progress"
    # This verifies nodes are correctly marked as "waiting" (not "unknown")
    (length(values(@)[?@ == 'waiting'])): 3
    (length(values(@)[?@ == 'in_progress'])): 3
